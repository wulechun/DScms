{extend name="layout:home" /}

{block name="container"}
<form class="layui-form" method="post" enctype="multipart/form-data">
    <div class="layui-tab layui-tab-card">
        {include file="layout/admin_items" /}
        <div class="layui-tab-content">
            <div class="layui-tab-item layui-show ">
                
                
                <div class="layui-collapse">
                    <div class="layui-colla-item">
                        <h2 class="layui-colla-title">基本设置</h2>
                        <div class="layui-colla-content layui-show">
                            <div class="layui-form-item">
                                <label class="layui-form-label">{$Think.lang.news_parent}</label>
                                <div class="layui-input-inline">
                                    <select name="column_id" id="column_id">
                                        <option value="">{:lang('ds_please_choose')}一级栏目</option>
                                    </select>
                                    <select name="column_id2" id="column_id2">
                                        <option value="">{:lang('ds_please_choose')}二级栏目</option>
                                    </select>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">{$Think.lang.news_title}</label>
                                <div class="layui-input-inline">
                                    <input type="text" class="layui-input field-name" name="news_title" id="news_title" value="{$news.news_title|default=''}" lay-verify="news_title" autocomplete="off" placeholder="{$Think.lang.ds_please_enter}{$Think.lang.news_title}" required />
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">{$Think.lang.news_order}</label>
                                <div class="layui-input-inline">
                                    <input type="text" class="layui-input field-name" name="news_order" id="news_order" value="{$news.news_order|default='255'}" lay-verify="news_order" autocomplete="off" required />
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">{$Think.lang.news_imgurl}</label>
                                <div class="layui-input-inline">
                                    {notempty name="$news.news_imgurl"}
                                    <img src="{:get_news_img($news['news_imgurl'])}" height="80"/>
                                    {/notempty}
                                    <input type="file" name="news_imgurl"/>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">{$Think.lang.news_displaytype}</label>
                                <div class="layui-input-inline">
                                    <input type="checkbox" name="news_displaytype" lay-skin="switch" lay-text="{$Think.lang.ds_yes}|{$Think.lang.ds_no}" value="1" {if condition="$news.news_displaytype eq '1'"}checked{/if}>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">{$Think.lang.news_wap_ok}</label>
                                <div class="layui-input-inline">
                                    <input type="checkbox" name="news_wap_ok" lay-skin="switch" lay-text="{$Think.lang.ds_yes}|{$Think.lang.ds_no}" value="1" {if condition="$news.news_wap_ok eq '1'"}checked{/if}>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="layui-colla-item">
                        <h2 class="layui-colla-title">详情内容</h2>
                        <div class="layui-colla-content">
                            <div class="layui-form-item">
                                <label class="layui-form-label">{$Think.lang.news_content}</label>
                                <div class="layui-input-block">
                                    {:build_editor(['name'=>'news_content','content'=>isset($news.news_content)?htmlspecialchars_decode($news.news_content):''])}
                                    <textarea name="news_content" id="news_content" style="min-height:400px;"></textarea>
                                </div>
                            </div>
                            <button type="button" class="layui-btn" id="upload_newspic"><i class="layui-icon"></i>{$Think.lang.ds_uploading_files}</button>
                            <div class="selected_pic clearfix">
                                <ul>
                                    {foreach name="pic_list" id="newspic"}
                                    <li id="{$newspic.pic_id}">
                                        <img src="{:get_news_img($newspic['pic_cover'])}"/>
                                        <i class="delect layui-icon" title="{$Think.lang.ds_insert_editor}" onclick="insert_editor('{:get_news_img($newspic['pic_cover'])}')">&#xe654;</i>
                                        <i class="insert layui-icon" title="{$Think.lang.ds_delete_picture}" onclick="del_newspic({$newspic.pic_id})">&#xe640;</i>
                                    </li>
                                    {/foreach}
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="layui-colla-item">
                        <h2 class="layui-colla-title">SEO设置</h2>
                        <div class="layui-colla-content">
                            <div class="layui-form-item">
                                <label class="layui-form-label">{$Think.lang.seo_title}</label>
                                <div class="layui-input-block">
                                    <input type="text" class="layui-input field-name" name="seo_title" id="seo_title" value="{$news.seo_title|default=''}" placeholder="{$Think.lang.ds_please_enter}{$Think.lang.seo_title}" />
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">{$Think.lang.seo_keywords}</label>
                                <div class="layui-input-block">
                                    <input type="text" class="layui-input field-name" name="seo_keywords" id="seo_keywords" value="{$news.seo_keywords|default=''}" placeholder="{$Think.lang.ds_please_enter}{$Think.lang.seo_keywords}" />
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">{$Think.lang.seo_description}</label>
                                <div class="layui-input-block">
                                    <textarea class="layui-textarea field-name" name="seo_description">{$news.seo_description|default=''}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="layui-form-item mt20">
                    <div class="layui-input-block">
                        <input type="submit" class="layui-btn layui-btn-normal" lay-submit value="{:lang('ds_submit')}" />
                    </div>
                </div>
                
                
                
            </div>
        </div>
    </div>
</form>
<script>
    layui.use('element', function () {
        var element = layui.element;
    });
    layui.use('form', function () {
        var form = layui.form;

        //监听提交
        form.on('submit(formDemo)', function (data) {
            layer.msg(JSON.stringify(data.field));
            return false;
        });
    });
</script>
<script>
    layui.use('laydate', function () {
        var laydate = layui.laydate;

        //执行一个laydate实例
        laydate.render({
            elem: '#news_addtime' //指定元素
        });
    });
</script>

<script>
    layui.use('form', function () {
        var form = layui.form;
    });
    layui.use('element', function () {
        var element = layui.element;
    });
    layui.use('laydate', function(){
        var laydate = layui.laydate;
        laydate.render({
            elem: '#news_addtime'
        });
    });
    /**
     * 图片异步上传
     */
    layui.use('upload', function () {
        var $ = layui.jquery, upload = layui.upload;
        //指定允许上传的文件类型
        upload.render({
            elem: '#upload_newspic'
            , url: "{:url('pic/upload',['pic_type_id'=>$Request.param.news_id,'pic_type'=>$news_pic_type.pic_type])}"
            , accept: 'file' //普通文件
            , done: function (res) {
                add_uploadedfile(res);
                console.log(res)
            }
        });
    });
    function add_uploadedfile(file_data)
    {
        var newImg = '<li id="' + file_data.file_id + '"><img src="' + file_data.file_url + '"/><i class="delect layui-icon" title="插入编辑器" onclick="insert_editor(\''+file_data.file_url+'\')">&#xe654;</i><i class="insert layui-icon" title="删除图片" onclick="del_newspic(' + file_data.file_id + ')">&#xe640;</i></li>'
        $('.selected_pic ul').prepend(newImg);
    }


    /**
     * 插入编辑器
     */
    function insert_editor(file_path){
        ue.execCommand('insertimage', {src:file_path});
    }

    function del_newspic(file_id)
    {
        layer.open({
            content: '{$Think.lang.ds_confirm_cancel}',
            yes: function(index, layero){
                $.getJSON("{:url('pic/del')}",{file_id: + file_id,pic_type:'news'}, function(result){
                    if(result){
                        $('#' + file_id).remove();
                        layer.msg('{$Think.lang.del_succ}');
                        layer.close(index);
                        return;
                    }else{
                        layer.msg('{$Think.lang.del_fail}');
                        layer.close(index);
                        return;
                    }
                });
            }
        });
    }
</script>
<script>
    var column_id = '{$news[\'column_id\']}';
    var column_id2 = '{$news[\'column_id2\']}';
    var webclass = {$column_list|raw};
    var column_id_index = -1;
    webclass.forEach(function(a,i){
        if(parseInt(column_id) == a[0]){
            column_id_index = i;
            $('select[name=column_id]').append('<option selected value="' + a[0] + '">' + a[1] + '</option>');
        }else {
            $('select[name=column_id]').append('<option value="' + a[0] + '">' + a[1] + '</option>');
        }
    });
    if(column_id_index != -1){
        webclass[column_id_index][2].forEach(function (a, i) {
            $('select[name=column_id2]').append('<option '+((column_id2==a['column_id'])?'selected':'')+' value="' + a['column_id'] + '">' + a['column_name'] + '</option>');
            $('select[name=column_id2]').next().find('.layui-anim-upbit').append('<dd lay-value="' + a['column_id'] + '" class="layui-this">' + a['column_name'] + '</dd>');
        });
    }
    $(function(){
        $('body').on('mouseup','.layui-anim-upbit:eq(0) dd',function(){
            $('select[name=column_id2] > option:gt(0)').remove();
            $('select[name=column_id2]').next().find('.layui-unselect').val($('select[name=column_id2]').next().find('.layui-anim-upbit > dd:eq(0)').text());
            $('select[name=column_id2]').next().find('.layui-anim-upbit > dd:gt(0)').remove();
            if($(this).index()){
                webclass[$(this).index()-1][2].forEach(function (a, i) {
                    $('select[name=column_id2]').append('<option value="' + a['column_id'] + '">' + a['column_name'] + '</option>');
                    $('select[name=column_id2]').next().find('.layui-anim-upbit').append('<dd lay-value="' + a['column_id'] + '" class="layui-this">' + a['column_name'] + '</dd>');
                });
            }
        });
        $('body').on('mouseup','.layui-anim-upbit:eq(1) dd',function() {
            $('select[name=column_id2]').get(0).selectedIndex = $(this).index();
            $('select[name=column_id2]').next().find('.layui-unselect').val($(this).text());
        });
    });
</script>

{/block}



